services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ${USER_ID:-ncafe}-backend
    ports:
      - "${BACKEND_PORT:-8081}:8081" # .env 파일이나 환경변수로 포트 변경 가능하도록 수정
    volumes:
      - /home/newlec/dist/ncafe/upload:/app/upload
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      # DB 컨테이너를 쓸 때는 서비스명 'db'를 호스트로 사용
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/ncafedb?useSSL=false&allowPublicKeyRetrieval=true
    restart: unless-stopped
    # DB 프로필을 켰을 때만 실행 순서 보장 (필수는 아님)
    depends_on:
      - db

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ${USER_ID:-ncafe}-frontend
    ports:
      - "${FRONTEND_PORT:-3001}:3001"
    environment:
      - NEXT_PUBLIC_API_URL=http://backend:8081
    depends_on:
      - backend
    restart: unless-stopped

  # DB 서비스 추가 (필요한 사람만 사용)
  db:
    image: postgres:17
    profiles: [ "with-db" ] # 이 프로필을 지정해야만 실행됨
    container_name: ${USER_ID:-ncafe}-db
    environment:
      POSTGRES_DB: ncafedb
      POSTGRES_USER: ncafe
      POSTGRES_PASSWORD: new_ibm2
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - /home/newlec/dist/ncafe/data:/var/lib/postgresql/data
    restart: unless-stopped
